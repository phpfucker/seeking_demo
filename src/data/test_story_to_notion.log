anopy , creating soft shadows and light spots . the focus is primarily on the faces and emotions of the characters . each animal is anthropom']
100%|█████████████████████████████████████████████████████████████████████████| 5/5 [02:40<00:00, 32.18s/it]
Potential NSFW content was detected in one or more images. A black image will be returned instead. Try again with a different prompt and/or seed.
イラスト生成完了: /app/uploads/test_illustration.png

4. 画像分析とプロンプト改善を開始...
DEBUG:openai._base_client:Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-4f1297e7-8cae-458f-905c-161c97b8d977', 'json_data': {'messages': [{'role': 'user', 'content': [{'type': 'text', 'text': 'この4コマ漫画の画像を分析し、以下の点について詳細に説明してください：\n1. 4コマ漫画としての構成（起承転結）\n2. 2x2グリッドレイアウトの適切性\n3. キャラクターの表現と一貫性\n4. 感情や雰囲気\n5. 技術的な品質\n6. 改善点'}, {'type': 'image_url', 'image_url': {'url': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAADACAIAAABkjyoxAAAApklEQVR4nO3BMQEAAADCoPVPbQlPoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgZA3gAB7eZfogAAAABJRU5ErkJggg=='}}]}], 'model': 'gpt-4o', 'max_tokens': 1000}}
DEBUG:openai._base_client:Sending HTTP Request: POST https://api.openai.com/v1/chat/completions
DEBUG:httpcore.connection:connect_tcp.started host='api.openai.com' port=443 local_address=None timeout=5.0 socket_options=None
DEBUG:httpcore.connection:connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7fb61ba88c10>
DEBUG:httpcore.connection:start_tls.started ssl_context=<ssl.SSLContext object at 0x7fb620915f40> server_hostname='api.openai.com' timeout=5.0
DEBUG:httpcore.connection:start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7fb61b846390>
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:20:45 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'access-control-expose-headers', b'X-Request-ID'), (b'openai-organization', b'user-yp71vr5e7ytqmp5r0elaafpl'), (b'openai-processing-ms', b'27269'), (b'openai-version', b'2020-10-01'), (b'x-envoy-upstream-service-time', b'27241'), (b'x-ratelimit-limit-input-images', b'50000'), (b'x-ratelimit-limit-requests', b'500'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-input-images', b'49999'), (b'x-ratelimit-remaining-requests', b'499'), (b'x-ratelimit-remaining-tokens', b'29157'), (b'x-ratelimit-reset-input-images', b'1ms'), (b'x-ratelimit-reset-requests', b'120ms'), (b'x-ratelimit-reset-tokens', b'1.686s'), (b'x-request-id', b'req_7f62459215a486726c086f641a958e87'), (b'strict-transport-security', b'max-age=31536000; includeSubDomains; preload'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=NATcik3cBcn_QdvgYC6trKW9dHuOamT4t7RzQiDjLNM-1749522045-1.0.1.1-jpaiSDV6uuIQRIdZOYC5sk6N8eAnOjjUrwbXZknTIlmDPjwKSVOy.XBnU33SD4XwIDJ46_Jb.rnBSSyRHnJbA6omYtG783pm9FqHRvv0Fb4; path=/; expires=Tue, 10-Jun-25 02:50:45 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), (b'X-Content-Type-Options', b'nosniff'), (b'Set-Cookie', b'_cfuvid=l2xYCQBLrZG.8nSwDf08emE9eGzX0fouATbKG2kAeDA-1749522045548-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'94d56382edc319e6-KIX'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:openai._base_client:HTTP Response: POST https://api.openai.com/v1/chat/completions "200 OK" Headers([('date', 'Tue, 10 Jun 2025 02:20:45 GMT'), ('content-type', 'application/json'), ('transfer-encoding', 'chunked'), ('connection', 'keep-alive'), ('access-control-expose-headers', 'X-Request-ID'), ('openai-organization', 'user-yp71vr5e7ytqmp5r0elaafpl'), ('openai-processing-ms', '27269'), ('openai-version', '2020-10-01'), ('x-envoy-upstream-service-time', '27241'), ('x-ratelimit-limit-input-images', '50000'), ('x-ratelimit-limit-requests', '500'), ('x-ratelimit-limit-tokens', '30000'), ('x-ratelimit-remaining-input-images', '49999'), ('x-ratelimit-remaining-requests', '499'), ('x-ratelimit-remaining-tokens', '29157'), ('x-ratelimit-reset-input-images', '1ms'), ('x-ratelimit-reset-requests', '120ms'), ('x-ratelimit-reset-tokens', '1.686s'), ('x-request-id', 'req_7f62459215a486726c086f641a958e87'), ('strict-transport-security', 'max-age=31536000; includeSubDomains; preload'), ('cf-cache-status', 'DYNAMIC'), ('set-cookie', '__cf_bm=NATcik3cBcn_QdvgYC6trKW9dHuOamT4t7RzQiDjLNM-1749522045-1.0.1.1-jpaiSDV6uuIQRIdZOYC5sk6N8eAnOjjUrwbXZknTIlmDPjwKSVOy.XBnU33SD4XwIDJ46_Jb.rnBSSyRHnJbA6omYtG783pm9FqHRvv0Fb4; path=/; expires=Tue, 10-Jun-25 02:50:45 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('x-content-type-options', 'nosniff'), ('set-cookie', '_cfuvid=l2xYCQBLrZG.8nSwDf08emE9eGzX0fouATbKG2kAeDA-1749522045548-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('server', 'cloudflare'), ('cf-ray', '94d56382edc319e6-KIX'), ('content-encoding', 'gzip'), ('alt-svc', 'h3=":443"; ma=86400')])
DEBUG:openai._base_client:request_id: req_7f62459215a486726c086f641a958e87
DEBUG:openai._base_client:Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-1cffc2c4-6c08-42ab-9eef-94e03f41cdcc', 'json_data': {'messages': [{'role': 'system', 'content': 'あなたはStable Diffusionのプロンプトエンジニアリングの専門家です。与えられた画像分析と元のプロンプトを基に、より効果的なプロンプトを生成してください。画像の特徴や目的に合わせて、柔軟にプロンプトを改善してください。'}, {'role': 'user', 'content': '\n以下の画像分析結果と元のプロンプトを基に、より効果的なStable Diffusionのプロンプトを生成してください。\n\n【画像分析結果】\nごめんなさい、この漫画のキャラクターや具体的な内容について説明することはできませんが、一般的な4コマ漫画の分析方法について説明します。\n\n1. **4コマ漫画としての構成（起承転結）**:\n   - **起**: 最初のコマで状況やキャラクターが紹介されます。物語の設定がされ、読者の興味を引きます。\n   - **承**: 次のコマで物語が進行し、起で紹介された状況が発展します。\n   - **転**: 3番目のコマで予想外の展開が現れ、物語が転換します。驚きやユーモアが生まれる重要なポイントです。\n   - **結**: 最後のコマで物語が結末に至り、全体のオチが描かれます。納得感や満足感を与えます。\n\n2. **2x2グリッドレイアウトの適切性**:\n   - 4コマ漫画では2x2グリッドがよく用いられています。線によって区切られた4つのコマはクリアで読みやすく、起承転結の流れを視覚的にサポートします。\n\n3. **キャラクターの表現と一貫性**:\n   - 一貫したキャラクターデザインや感情表現は、読者にとってキャラクターを認識しやすくし、物語への没入感を高めます。\n\n4. **感情や雰囲気**:\n   - 各コマを通じてキャラクターの感情が明確に伝わると、読者はその場面をより深く理解できます。表情や状況設定を通して雰囲気を緻密に表現することが大切です。\n\n5. **技術的な品質**:\n   - 綺麗な線画、適切な文字サイズ、読みやすい吹き出しは、全体の品質に影響します。視覚的にクリアであることが重要です。\n\n6. **改善点**:\n   - 読者にメッセージが伝わりにくい場合、コマの流れを再考するか、ビジュアルやテキストを再調整して明確にすることが求められます。視覚的な混乱を避け、一貫したテーマを持たせることも役立ちます。\n\nこの指針をもとに、漫画の改善点などを考えることができます。\n\n【元のプロンプト】\n第1話：「膝と膝」\n\nシーン1:\n- 舞台は風光明媚な森の中。リーダーシップのある頼れる動物のような存在、ライオンの「レオ」が他の4人の仲間を集めている。\n- レオ:「今日は皆に大切な話がある。膝を突き合わせて、心を通わせよう」\n- 他の仲間たちも興味津々で、膝を突き合わせる。\n\nシーン2:\n- 一瞬の沈黙の後、癒し系で優しい宝石のような存在、ユニコーンの「ユニ」が口を開く。\n- ユニ:「私たちがずっと一緒にいること、それが大切なのです」\n- 他の仲間たちもユニの言葉に深く共感し、絆が深まる。\n\nシーン3:\n- 明るくユーモラスな存在、キツネの「キツ」が軽快なトークで雰囲気を和ませる。\n- キツ:「そうだよ、みんな！楽しいこと探しに行こうよ！」\n- 仲間たちは笑顔に包まれ、キツネの明るさに励まされる。\n\nシーン4:\n- 芸術を愛する存在、孔雀の「クジャク」が美しい羽を広げて語り始める。\n- クジャク:「美しさは心を豊かにする。心の美しさを大切にしよう」\n- 仲間たちはクジャクの言葉に感動し、芸術の力を再認識する。\n\nシーン5:\n- 知識が豊富で思慮深い存在、フクロウの「フク」が最後にまとめる。\n- フク:「皆さんの言葉には深い意味があります。お互いを大切にし、尊重し合いましょう」\n- 仲間たちはフクロウの知恵に感心し、お互いを理解する大切さを再確認する。\n\nシーン6:\n- 5人の仲間が膝を突き合わせて笑顔で固く握手を交わす。深い理解と絆で結ばれた彼らは、未来への旅路に向かって歩み出す。\n\n- こうして、膝と膝を突き合わせ、心を通わせる5人の存在たちの冒険が始まった。\n\n以下の要素を考慮して、改善されたプロンプトを生成してください。\n各要素はBREAKで区切り、重み付けを指定してください：\n\n1. メインサブジェクトとキャラクター (weight: 1.2)\n- 主要なキャラクターの特徴\n- 表情や動作\n- 重要なオブジェクト\n- ストーリーの中心となる要素\n\n2. シーンと背景 (weight: 1.0)\n- 背景の設定\n- 環境の描写\n- 空間の構成\n- 時間帯や天候\n\n3. スタイルと雰囲気 (weight: 0.8)\n- アートスタイル\n- 全体的な雰囲気\n- 感情表現\n- 色調やトーン\n\n4. 技術的な詳細 (weight: 0.6)\n- 構図のバランス\n- ライティング効果\n- 画質や解像度\n- 特殊効果\n\n出力形式：\n(subject:1.2) [メインサブジェクトとキャラクターの詳細] BREAK\n(background:1.0) [シーンと背景の詳細] BREAK\n(style:0.8) [スタイルと雰囲気の詳細] BREAK\n(technical:0.6) [技術的な詳細]\n\n注意事項：\n- 各セクションは75トークン以内に収めてください\n- 重要な要素には重み付けを調整してください\n- 出力は英語で、簡潔に記述してください\n'}], 'model': 'gpt-4', 'max_tokens': 1000, 'temperature': 0.7}}
DEBUG:openai._base_client:Sending HTTP Request: POST https://api.openai.com/v1/chat/completions
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:20:57 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'access-control-expose-headers', b'X-Request-ID'), (b'openai-organization', b'user-yp71vr5e7ytqmp5r0elaafpl'), (b'openai-processing-ms', b'10173'), (b'openai-version', b'2020-10-01'), (b'x-envoy-upstream-service-time', b'10180'), (b'x-ratelimit-limit-requests', b'10000'), (b'x-ratelimit-limit-tokens', b'10000'), (b'x-ratelimit-remaining-requests', b'9999'), (b'x-ratelimit-remaining-tokens', b'8564'), (b'x-ratelimit-reset-requests', b'8.64s'), (b'x-ratelimit-reset-tokens', b'8.616s'), (b'x-request-id', b'req_1b5613ada5e893226f6dee40183eecd6'), (b'strict-transport-security', b'max-age=31536000; includeSubDomains; preload'), (b'cf-cache-status', b'DYNAMIC'), (b'X-Content-Type-Options', b'nosniff'), (b'Server', b'cloudflare'), (b'CF-RAY', b'94d56435992519e6-KIX'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:openai._base_client:HTTP Response: POST https://api.openai.com/v1/chat/completions "200 OK" Headers({'date': 'Tue, 10 Jun 2025 02:20:57 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'access-control-expose-headers': 'X-Request-ID', 'openai-organization': 'user-yp71vr5e7ytqmp5r0elaafpl', 'openai-processing-ms': '10173', 'openai-version': '2020-10-01', 'x-envoy-upstream-service-time': '10180', 'x-ratelimit-limit-requests': '10000', 'x-ratelimit-limit-tokens': '10000', 'x-ratelimit-remaining-requests': '9999', 'x-ratelimit-remaining-tokens': '8564', 'x-ratelimit-reset-requests': '8.64s', 'x-ratelimit-reset-tokens': '8.616s', 'x-request-id': 'req_1b5613ada5e893226f6dee40183eecd6', 'strict-transport-security': 'max-age=31536000; includeSubDomains; preload', 'cf-cache-status': 'DYNAMIC', 'x-content-type-options': 'nosniff', 'server': 'cloudflare', 'cf-ray': '94d56435992519e6-KIX', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
DEBUG:openai._base_client:request_id: req_1b5613ada5e893226f6dee40183eecd6
プロンプトテンプレートを更新しました: /app/src/prompts/manga_prompt.txt
画像分析とプロンプト改善完了

5. Notion連携テスト開始...
DEBUG:httpcore.connection:connect_tcp.started host='api.notion.com' port=443 local_address=None timeout=60.0 socket_options=None
DEBUG:httpcore.connection:connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7fb61b8534d0>
DEBUG:httpcore.connection:start_tls.started ssl_context=<ssl.SSLContext object at 0x7fb620916060> server_hostname='api.notion.com' timeout=60.0
DEBUG:httpcore.connection:start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7fb61b853550>
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:21:02 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d5647e19ea9629-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'ETag', b'W/"448-X6BwSMtXr0GsnNpj1Lfk7qAwn5M"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'059455a3-9190-40c4-a717-5590d1f9600a'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Set-Cookie', b'__cf_bm=ly6AF4t1BgtQg.VdkNUlpJ8kRq3.XJmVzjGigbEPz8o-1749522062-1.0.1.1-B4JBdK2ehIFOr2qbd2i96D7c_2DOEXASl9M8oEcu2T0Ic1VdOYLrPYUi1oJ1SspszSfDqW0GKCLh1z7buFJ_ePa4kY4L_xkPsjPgqXXzr88; path=/; expires=Tue, 10-Jun-25 02:51:02 GMT; domain=.notion.com; HttpOnly; Secure; SameSite=None'), (b'Set-Cookie', b'_cfuvid=qrglVqi.PE3vSPXJBljNfGYLnZBO2O51_FmyeBRGgLs-1749522062137-0.0.1.1-604800000; path=/; domain=.notion.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.notion.com/v1/pages "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:21:02 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d564995a789629-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'ETag', b'W/"1fd8-lgyY/b/S5kqs62EcQONl02iCbaM"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'5a2102c7-fc39-4d6c-aad5-08e7cf49d385'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Server', b'cloudflare'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: PATCH https://api.notion.com/v1/blocks/20e2d8fa-cbd4-817f-8287-cbef228de4bc/children "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:21:03 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d5649dbf839629-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'ETag', b'W/"f94-0+USQPoR8ifjKEa8NaK9rcStlsc"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'3fd0720d-589e-4cba-8d61-d2b23c01edca'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Server', b'cloudflare'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: PATCH https://api.notion.com/v1/blocks/20e2d8fa-cbd4-817f-8287-cbef228de4bc/children "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:boto3.s3.transfer:Opting out of CRT Transfer Manager. Preferred client: auto, CRT available: False, Instance Optimized: False.
DEBUG:boto3.s3.transfer:Using default client. pid: 125, thread: 140424074947456
DEBUG:s3transfer.utils:Acquiring 0
DEBUG:s3transfer.tasks:UploadSubmissionTask(transfer_id=0, {'transfer_future': <s3transfer.futures.TransferFuture object at 0x7fb61ba83c10>}) about to wait for the following futures []
DEBUG:s3transfer.tasks:UploadSubmissionTask(transfer_id=0, {'transfer_future': <s3transfer.futures.TransferFuture object at 0x7fb61ba83c10>}) done waiting for dependent futures
DEBUG:s3transfer.tasks:Executing task UploadSubmissionTask(transfer_id=0, {'transfer_future': <s3transfer.futures.TransferFuture object at 0x7fb61ba83c10>}) with kwargs {'client': <botocore.client.S3 object at 0x7fb62d83bc10>, 'config': <boto3.s3.transfer.TransferConfig object at 0x7fb61b7cbf10>, 'osutil': <s3transfer.utils.OSUtils object at 0x7fb61b917890>, 'request_executor': <s3transfer.futures.BoundedExecutor object at 0x7fb61b7c8e90>, 'transfer_future': <s3transfer.futures.TransferFuture object at 0x7fb61ba83c10>}
DEBUG:s3transfer.futures:Submitting task PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_022103_test_illustration.png', 'extra_args': {}}) to executor <s3transfer.futures.BoundedExecutor object at 0x7fb61b7c8e90> for transfer request: 0.
DEBUG:s3transfer.utils:Acquiring 0
DEBUG:s3transfer.tasks:PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_022103_test_illustration.png', 'extra_args': {}}) about to wait for the following futures []
DEBUG:s3transfer.utils:Releasing acquire 0/None
DEBUG:s3transfer.tasks:PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_022103_test_illustration.png', 'extra_args': {}}) done waiting for dependent futures
DEBUG:s3transfer.tasks:Executing task PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_022103_test_illustration.png', 'extra_args': {}}) with kwargs {'client': <botocore.client.S3 object at 0x7fb62d83bc10>, 'fileobj': <s3transfer.utils.ReadFileChunk object at 0x7fb61b85b410>, 'bucket': 'phpfuckertest', 'key': 'generated/20250610_022103_test_illustration.png', 'extra_args': {}}
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function validate_ascii_metadata at 0x7fb62d407a60>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function sse_md5 at 0x7fb62d406d40>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function convert_body_to_file_like_object at 0x7fb62d4244a0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function validate_bucket_name at 0x7fb62d406ca0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function remove_bucket_from_url_paths_from_model at 0x7fb62d424ea0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <bound method S3RegionRedirectorv2.annotate_request_context of <botocore.utils.S3RegionRedirectorv2 object at 0x7fb621ca4ed0>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <bound method ClientCreator._inject_s3_input_parameters of <botocore.client.ClientCreator object at 0x7fb622189290>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function generate_idempotent_uuid at 0x7fb62d406ac0>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <function customize_endpoint_resolver_builtins at 0x7fb62d425080>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <bound method S3RegionRedirectorv2.redirect_from_cache of <botocore.utils.S3RegionRedirectorv2 object at 0x7fb621ca4ed0>>
DEBUG:botocore.regions:Calling endpoint provider with parameters: {'Bucket': 'phpfuckertest', 'Region': 'ap-northeast-1', 'UseFIPS': False, 'UseDualStack': False, 'ForcePathStyle': False, 'Accelerate': False, 'UseGlobalEndpoint': False, 'Key': 'generated/20250610_022103_test_illustration.png', 'DisableMultiRegionAccessPoints': False, 'UseArnRegion': True}
DEBUG:botocore.regions:Endpoint provider result: https://phpfuckertest.s3.ap-northeast-1.amazonaws.com
DEBUG:botocore.regions:Selecting from endpoint provider's list of auth schemes: "sigv4". User selected auth scheme is: "s3v4"
DEBUG:botocore.regions:Selected auth type "v4" as "s3v4" with signing context params: {'region': 'ap-northeast-1', 'signing_name': 's3', 'disableDoubleEncoding': True}
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function conditionally_calculate_checksum at 0x7fb62d4a2200>
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function add_expect_header at 0x7fb62d407060>
DEBUG:botocore.handlers:Adding expect 100 continue header to request.
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <bound method S3ExpressIdentityResolver.apply_signing_cache_key of <botocore.utils.S3ExpressIdentityResolver object at 0x7fb621ca5910>>
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function add_recursion_detection_header at 0x7fb62d4053a0>
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function inject_api_version_header_if_needed at 0x7fb62d4245e0>
DEBUG:botocore.endpoint:Making request for OperationModel(name=PutObject) with params: {'url_path': '/generated/20250610_022103_test_illustration.png', 'query_string': {}, 'method': 'PUT', 'headers': {'User-Agent': 'Boto3/1.34.69 md/Botocore#1.34.162 ua/2.0 os/linux#5.10.104-linuxkit md/arch#x86_64 lang/python#3.11.13 md/pyimpl#CPython cfg/retry-mode#standard Botocore/1.34.162', 'Content-MD5': 'fpIRfsN3+S7frPYLsDXGAQ==', 'Expect': '100-continue'}, 'body': <s3transfer.utils.ReadFileChunk object at 0x7fb61b85b410>, 'auth_path': '/phpfuckertest/generated/20250610_022103_test_illustration.png', 'url': 'https://phpfuckertest.s3.ap-northeast-1.amazonaws.com/generated/20250610_022103_test_illustration.png', 'context': {'client_region': 'ap-northeast-1', 'client_config': <botocore.config.Config object at 0x7fb6220de190>, 'has_streaming_input': True, 'auth_type': 's3v4', 's3_redirect': {'redirected': False, 'bucket': 'phpfuckertest', 'params': {'Bucket': 'phpfuckertest', 'Key': 'generated/20250610_022103_test_illustration.png', 'Body': <s3transfer.utils.ReadFileChunk object at 0x7fb61b85b410>}}, 'input_params': {'Bucket': 'phpfuckertest', 'Key': 'generated/20250610_022103_test_illustration.png'}, 'signing': {'region': 'ap-northeast-1', 'signing_name': 's3', 'disableDoubleEncoding': True}, 'endpoint_properties': {'authSchemes': [{'disableDoubleEncoding': True, 'name': 'sigv4', 'signingName': 's3', 'signingRegion': 'ap-northeast-1'}]}}}
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <function signal_not_transferring at 0x7fb622104b80>
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <bound method RequestSigner.handler of <botocore.signers.RequestSigner object at 0x7fb621c90890>>
DEBUG:botocore.hooks:Event choose-signer.s3.PutObject: calling handler <function set_operation_specific_signer at 0x7fb62d406980>
DEBUG:botocore.hooks:Event before-sign.s3.PutObject: calling handler <function remove_arn_from_signing_path at 0x7fb62d424fe0>
DEBUG:botocore.hooks:Event before-sign.s3.PutObject: calling handler <bound method S3ExpressIdentityResolver.resolve_s3express_identity of <botocore.utils.S3ExpressIdentityResolver object at 0x7fb621ca5910>>
DEBUG:botocore.auth:Calculating signature using v4 auth.
DEBUG:botocore.auth:CanonicalRequest:
PUT
/generated/20250610_022103_test_illustration.png

content-md5:fpIRfsN3+S7frPYLsDXGAQ==
host:phpfuckertest.s3.ap-northeast-1.amazonaws.com
x-amz-content-sha256:UNSIGNED-PAYLOAD
x-amz-date:20250610T022104Z

content-md5;host;x-amz-content-sha256;x-amz-date
UNSIGNED-PAYLOAD
DEBUG:botocore.auth:StringToSign:
AWS4-HMAC-SHA256
20250610T022104Z
20250610/ap-northeast-1/s3/aws4_request
f6a816b5151e529b73a99cf4025fd4cf1706e88f2e2578f2ed50afa7350907fd
DEBUG:botocore.auth:Signature:
7c663523d1a82e77df2b62494825d4119773346e6aaed01ffa9eb170a40c715f
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <function signal_transferring at 0x7fb622104c20>
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <function add_retry_headers at 0x7fb62d424e00>
DEBUG:botocore.endpoint:Sending http request: <AWSPreparedRequest stream_output=False, method=PUT, url=https://phpfuckertest.s3.ap-northeast-1.amazonaws.com/generated/20250610_022103_test_illustration.png, headers={'User-Agent': b'Boto3/1.34.69 md/Botocore#1.34.162 ua/2.0 os/linux#5.10.104-linuxkit md/arch#x86_64 lang/python#3.11.13 md/pyimpl#CPython cfg/retry-mode#standard Botocore/1.34.162', 'Content-MD5': b'fpIRfsN3+S7frPYLsDXGAQ==', 'Expect': b'100-continue', 'X-Amz-Date': b'20250610T022104Z', 'X-Amz-Content-SHA256': b'UNSIGNED-PAYLOAD', 'Authorization': b'AWS4-HMAC-SHA256 Credential=AKIAS4J7W4GLMR5IV6UL/20250610/ap-northeast-1/s3/aws4_request, SignedHeaders=content-md5;host;x-amz-content-sha256;x-amz-date, Signature=7c663523d1a82e77df2b62494825d4119773346e6aaed01ffa9eb170a40c715f', 'amz-sdk-invocation-id': b'c51b8100-82b4-417b-b2b2-65bfe1f2b562', 'amz-sdk-request': b'attempt=1', 'Content-Length': '223'}>
DEBUG:botocore.httpsession:Certificate path: /usr/local/lib/python3.11/site-packages/certifi/cacert.pem
DEBUG:urllib3.connectionpool:Starting new HTTPS connection (1): phpfuckertest.s3.ap-northeast-1.amazonaws.com:443
DEBUG:botocore.awsrequest:Waiting for 100 Continue response.
DEBUG:botocore.awsrequest:100 Continue response seen, now sending request body.
DEBUG:urllib3.connectionpool:https://phpfuckertest.s3.ap-northeast-1.amazonaws.com:443 "PUT /generated/20250610_022103_test_illustration.png HTTP/1.1" 200 0
DEBUG:botocore.parsers:Response headers: {'x-amz-id-2': 'k/3qJwMyKhH4/hd0UAazM3oepqEvfmefOugHUuE7QsAnPNahJSKukiFK9pgaV0Wyg8wgd6xNFWER/hPt2gBzjw==', 'x-amz-request-id': 'F1ZDA6N4RJPPCGYA', 'Date': 'Tue, 10 Jun 2025 02:21:06 GMT', 'x-amz-version-id': 'mI7v1GH05IjPPNGxoPDLeKrnUF2lYgQr', 'x-amz-server-side-encryption': 'AES256', 'ETag': '"7e92117ec377f92edfacf60bb035c601"', 'x-amz-checksum-crc64nvme': '5C8l2Q73V20=', 'x-amz-checksum-type': 'FULL_OBJECT', 'Content-Length': '0', 'Server': 'AmazonS3'}
DEBUG:botocore.parsers:Response body:
b''
DEBUG:botocore.hooks:Event needs-retry.s3.PutObject: calling handler <bound method RetryHandler.needs_retry of <botocore.retries.standard.RetryHandler object at 0x7fb621ca5450>>
DEBUG:botocore.retries.standard:Not retrying request.
DEBUG:botocore.hooks:Event needs-retry.s3.PutObject: calling handler <bound method S3RegionRedirectorv2.redirect_from_error of <botocore.utils.S3RegionRedirectorv2 object at 0x7fb621ca4ed0>>
DEBUG:botocore.hooks:Event after-call.s3.PutObject: calling handler <bound method RetryQuotaChecker.release_retry_quota of <botocore.retries.standard.RetryQuotaChecker object at 0x7fb621ca45d0>>
DEBUG:s3transfer.utils:Releasing acquire 0/None
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function sse_md5 at 0x7fb62d406d40>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function validate_bucket_name at 0x7fb62d406ca0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function remove_bucket_from_url_paths_from_model at 0x7fb62d424ea0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <bound method S3RegionRedirectorv2.annotate_request_context of <botocore.utils.S3RegionRedirectorv2 object at 0x7fb621ca4ed0>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <bound method ClientCreator._inject_s3_input_parameters of <botocore.client.ClientCreator object at 0x7fb622189290>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function generate_idempotent_uuid at 0x7fb62d406ac0>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <function customize_endpoint_resolver_builtins at 0x7fb62d425080>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <bound method S3RegionRedirectorv2.redirect_from_cache of <botocore.utils.S3RegionRedirectorv2 object at 0x7fb621ca4ed0>>
DEBUG:botocore.regions:Calling endpoint provider with parameters: {'Bucket': 'phpfuckertest', 'Region': 'aws-global', 'UseFIPS': False, 'UseDualStack': False, 'ForcePathStyle': False, 'Accelerate': False, 'UseGlobalEndpoint': True, 'Key': 'generated/20250610_022103_test_illustration.png', 'DisableMultiRegionAccessPoints': False, 'UseArnRegion': True}
DEBUG:botocore.regions:Endpoint provider result: https://phpfuckertest.s3.amazonaws.com
DEBUG:botocore.regions:Selecting from endpoint provider's list of auth schemes: "sigv4". User selected auth scheme is: "s3v4"
DEBUG:botocore.regions:Selected auth type "v4" as "s3v4" with signing context params: {'region': 'us-east-1', 'signing_name': 's3', 'disableDoubleEncoding': True}
DEBUG:botocore.hooks:Event choose-signer.s3.GetObject: calling handler <function set_operation_specific_signer at 0x7fb62d406980>
DEBUG:botocore.hooks:Event before-sign.s3.GetObject: calling handler <function remove_arn_from_signing_path at 0x7fb62d424fe0>
DEBUG:botocore.hooks:Event before-sign.s3.GetObject: calling handler <bound method S3ExpressIdentityResolver.resolve_s3express_identity of <botocore.utils.S3ExpressIdentityResolver object at 0x7fb621ca5910>>
DEBUG:botocore.auth:Calculating signature using v4 auth.
DEBUG:botocore.auth:CanonicalRequest:
GET
/generated/20250610_022103_test_illustration.png
X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS4J7W4GLMR5IV6UL%2F20250610%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20250610T022105Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host
host:phpfuckertest.s3.amazonaws.com

host
UNSIGNED-PAYLOAD
DEBUG:botocore.auth:StringToSign:
AWS4-HMAC-SHA256
20250610T022105Z
20250610/ap-northeast-1/s3/aws4_request
390c51ff755cbe49e78ab7e42ca9bdf41d8327632e275c9bb1408e37958c2f65
DEBUG:botocore.auth:Signature:
990931efe59dd00e7592840b747c9e0624b1156c3afac30645fb1e4fa1db5b31
[DEBUG] upload_image_to_notion: image_url: https://phpfuckertest.s3.amazonaws.com/generated/20250610_022103_test_illustration.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS4J7W4GLMR5IV6UL%2F20250610%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20250610T022105Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=990931efe59dd00e7592840b747c9e0624b1156c3afac30645fb1e4fa1db5b31
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:21:07 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d564ae4b349629-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'ETag', b'W/"3f8-eP5dkreMghO7lEiIA9KG14/Vjk8"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'07054965-264e-4992-b289-5f6e0beb481e'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Server', b'cloudflare'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: PATCH https://api.notion.com/v1/blocks/20e2d8fa-cbd4-817f-8287-cbef228de4bc/children "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
[DEBUG] upload_image_to_notion: append response: {'object': 'list', 'results': [{'object': 'block', 'id': '20e2d8fa-cbd4-8109-82c0-de6e89d50d29', 'parent': {'type': 'page_id', 'page_id': '20e2d8fa-cbd4-817f-8287-cbef228de4bc'}, 'created_time': '2025-06-10T02:21:00.000Z', 'last_edited_time': '2025-06-10T02:21:00.000Z', 'created_by': {'object': 'user', 'id': '2e7c4192-3008-4b55-9edf-b96cf513694e'}, 'last_edited_by': {'object': 'user', 'id': '2e7c4192-3008-4b55-9edf-b96cf513694e'}, 'has_children': False, 'archived': False, 'in_trash': False, 'type': 'image', 'image': {'caption': [], 'type': 'external', 'external': {'url': 'https://phpfuckertest.s3.amazonaws.com/generated/20250610_022103_test_illustration.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS4J7W4GLMR5IV6UL%2F20250610%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20250610T022105Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=990931efe59dd00e7592840b747c9e0624b1156c3afac30645fb1e4fa1db5b31'}}}], 'next_cursor': None, 'has_more': False, 'type': 'block', 'block': {}, 'request_id': '07054965-264e-4992-b289-5f6e0beb481e'}
Notionへの保存完了: 20e2d8fa-cbd4-817f-8287-cbef228de4bc

テスト完了: すべての処理が正常に実行されました
.
----------------------------------------------------------------------
Ran 1 test in 343.332s

OK
DEBUG:httpcore.connection:close.started
DEBUG:httpcore.connection:close.complete
DEBUG:httpcore.connection:close.started
DEBUG:httpcore.connection:close.complete
motosue@cesare seekin_demo % docker-compose exec app python src/tests/test_story_to_notion.py
DEBUG:urllib3.connectionpool:Starting new HTTPS connection (1): huggingface.co:443
DEBUG:urllib3.connectionpool:https://huggingface.co:443 "GET /api/models/runwayml/stable-diffusion-v1-5 HTTP/1.1" 307 90
DEBUG:urllib3.connectionpool:https://huggingface.co:443 "GET /api/models/stable-diffusion-v1-5/stable-diffusion-v1-5 HTTP/1.1" 200 6194
DEBUG:urllib3.connectionpool:https://huggingface.co:443 "HEAD /runwayml/stable-diffusion-v1-5/resolve/main/model_index.json HTTP/1.1" 307 0
DEBUG:urllib3.connectionpool:https://huggingface.co:443 "HEAD /stable-diffusion-v1-5/stable-diffusion-v1-5/resolve/main/model_index.json HTTP/1.1" 200 0
Loading pipeline components...: 100%|█████████████████████████████████████████| 7/7 [00:05<00:00,  1.28it/s]

1. ストーリー生成を開始...
DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): localhost:3000
DEBUG:urllib3.connectionpool:http://localhost:3000 "POST /generate-story HTTP/1.1" 200 2812
ストーリー生成完了

2. ストーリーをイラスト用プロンプトに変換...
DEBUG:openai._base_client:Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-5c47ea14-fd2a-49fb-b7bc-0e423510c06b', 'json_data': {'messages': [{'role': 'system', 'content': 'You are a professional illustrator and prompt engineer. Given the following story, create a single, vivid English prompt suitable for Stable Diffusion image generation. The prompt should be structured in groups separated by BREAK, with each group focusing on different aspects: 1. Main subject and characters (weight: 1.2) 2. Scene and background (weight: 1.0) 3. Style and atmosphere (weight: 0.8) 4. Technical details (weight: 0.6) Each group should be concise and focused. Use BREAK to separate groups. Format: (subject:1.2), (background:1.0), (style:0.8), (technical:0.6)'}, {'role': 'user', 'content': 'Story:\n【第1話：膝と膝】\n\n**シーン1:**\n- 舞台は森の中。リーダーシップのある頼れる動物のような存在が、他の4人の存在を呼び集めている。\n- 頼れる存在：「今日は特別な日だ。各自、膝と膝を突き合わせ、心を通わせよう。」\n- 他の4人は興味津々そうな表情を浮かべる。\n\n**シーン2:**\n- 優しい宝石のような存在と、明るくユーモラスな存在が膝と膝を突き合わせる。\n- 宝石のような存在：「あなたの心、とても温かいですね。」\n- ユーモラスな存在：「そりゃあ、笑いのセンスがいいからさ！」\n- 2人の距離がグッと縮まる。\n\n**シーン3:**\n- 芸術を愛する存在と、知識が豊富で思慮深い存在も膝と膝を突き合わせる。\n- 芸術を愛する存在：「あなたの作品、本当に美しい。感動したわ。」\n- 思慮深い存在：「ありがとうございます。でも、あなたの見方もまた新しい視点を開かせてくれますね。」\n- 2人の間には、深い理解が芽生える。\n\n**シーン4:**\n- 最後に頼れる存在が、全員に微笑む。\n- 頼れる存在：「膝と膝を突き合わせれば、心が通じ合うことができる。これからもお互いを理解し合い、協力していこう。」\n- 全員が頷き合い、団結を深める。\n\n【第1話完】'}], 'model': 'gpt-4', 'max_tokens': 200}}
DEBUG:openai._base_client:Sending HTTP Request: POST https://api.openai.com/v1/chat/completions
DEBUG:httpcore.connection:connect_tcp.started host='api.openai.com' port=443 local_address=None timeout=5.0 socket_options=None
DEBUG:httpcore.connection:connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7f1cb27c8bd0>
DEBUG:httpcore.connection:start_tls.started ssl_context=<ssl.SSLContext object at 0x7f1cb363d6d0> server_hostname='api.openai.com' timeout=5.0
DEBUG:httpcore.connection:start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7f1cb3e2f990>
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:35:37 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'access-control-expose-headers', b'X-Request-ID'), (b'openai-organization', b'user-yp71vr5e7ytqmp5r0elaafpl'), (b'openai-processing-ms', b'7170'), (b'openai-version', b'2020-10-01'), (b'x-envoy-upstream-service-time', b'7174'), (b'x-ratelimit-limit-requests', b'10000'), (b'x-ratelimit-limit-tokens', b'10000'), (b'x-ratelimit-remaining-requests', b'9999'), (b'x-ratelimit-remaining-tokens', b'9495'), (b'x-ratelimit-reset-requests', b'8.64s'), (b'x-ratelimit-reset-tokens', b'3.03s'), (b'x-request-id', b'req_40bacecbd9f45cba07a4f2df81627ce5'), (b'strict-transport-security', b'max-age=31536000; includeSubDomains; preload'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=12k3ukh4FdjHHcg2IQIuJTUMDnaDqEJ1Olr2km18ZsY-1749522937-1.0.1.1-8yfeYfOLL3fO.hhQl_RHrJjHT.4jmNr74Un._qJaXFOrj6YawaRTq1uQ1W0vPxzUv2ggr_lIa775mflmD2JjTAvJgEzIhlr18.MBmwKYECE; path=/; expires=Tue, 10-Jun-25 03:05:37 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), (b'X-Content-Type-Options', b'nosniff'), (b'Set-Cookie', b'_cfuvid=M.qJvyX_b5kRs12XdbQL5fLvG0e_fydVpZAlTFh.XgI-1749522937122-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'94d579c4ae6e00c7-KIX'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:openai._base_client:HTTP Response: POST https://api.openai.com/v1/chat/completions "200 OK" Headers([('date', 'Tue, 10 Jun 2025 02:35:37 GMT'), ('content-type', 'application/json'), ('transfer-encoding', 'chunked'), ('connection', 'keep-alive'), ('access-control-expose-headers', 'X-Request-ID'), ('openai-organization', 'user-yp71vr5e7ytqmp5r0elaafpl'), ('openai-processing-ms', '7170'), ('openai-version', '2020-10-01'), ('x-envoy-upstream-service-time', '7174'), ('x-ratelimit-limit-requests', '10000'), ('x-ratelimit-limit-tokens', '10000'), ('x-ratelimit-remaining-requests', '9999'), ('x-ratelimit-remaining-tokens', '9495'), ('x-ratelimit-reset-requests', '8.64s'), ('x-ratelimit-reset-tokens', '3.03s'), ('x-request-id', 'req_40bacecbd9f45cba07a4f2df81627ce5'), ('strict-transport-security', 'max-age=31536000; includeSubDomains; preload'), ('cf-cache-status', 'DYNAMIC'), ('set-cookie', '__cf_bm=12k3ukh4FdjHHcg2IQIuJTUMDnaDqEJ1Olr2km18ZsY-1749522937-1.0.1.1-8yfeYfOLL3fO.hhQl_RHrJjHT.4jmNr74Un._qJaXFOrj6YawaRTq1uQ1W0vPxzUv2ggr_lIa775mflmD2JjTAvJgEzIhlr18.MBmwKYECE; path=/; expires=Tue, 10-Jun-25 03:05:37 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('x-content-type-options', 'nosniff'), ('set-cookie', '_cfuvid=M.qJvyX_b5kRs12XdbQL5fLvG0e_fydVpZAlTFh.XgI-1749522937122-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('server', 'cloudflare'), ('cf-ray', '94d579c4ae6e00c7-KIX'), ('content-encoding', 'gzip'), ('alt-svc', 'h3=":443"; ma=86400')])
DEBUG:openai._base_client:request_id: req_40bacecbd9f45cba07a4f2df81627ce5
イラスト用プロンプト:
(subject:1.2) Five animated characters in a forest: a reliable, leader-like figure, a gentle gem-like character, a humorous sunny persona, an artistic enthusiast, and a thoughtful, knowledgeable being. BREAK (background:1.0) They are having a meeting in a serene, dense woodland filled with towering trees, a clear blue sky peeping through the canopy. BREAK (style:0.8) The illustration style is semi-realistic, filled with soft yet vibrant colors, with a whimsical and slightly dreamy atmosphere. BREAK (technical:0.6) Highlight the key emotion of each character, demonstrate they're 'kneeling knee-to-knee' for connection, ensure their closeness, and enunciate the feeling of deep unity and camaraderie.

3. イラスト生成を開始...
Token indices sequence length is longer than the specified maximum sequence length for this model (163 > 77). Running this sequence through the model will result in indexing errors
The following part of your input was truncated because CLIP can only handle sequences up to 77 tokens: ["through the canopy . break ( style : 0 . 8 ) the illustration style is semi - realistic , filled with soft yet vibrant colors , with a whimsical and slightly dreamy atmosphere . break ( technical : 0 . 6 ) highlight the key emotion of each character , demonstrate they 're ' kneeling knee - to - knee ' for connection , ensure their closeness , and enunciate the feeling of deep unity and camaraderie ."]
100%|█████████████████████████████████████████████████████████████████████████| 5/5 [03:48<00:00, 45.77s/it]
Potential NSFW content was detected in one or more images. A black image will be returned instead. Try again with a different prompt and/or seed.
イラスト生成完了: /app/uploads/test_illustration.png

4. 画像分析とプロンプト改善を開始...
DEBUG:openai._base_client:Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-e790fb38-4885-42ad-937f-1a25899e623b', 'json_data': {'messages': [{'role': 'user', 'content': [{'type': 'text', 'text': 'この4コマ漫画の画像を分析し、以下の点について詳細に説明してください：\n1. 4コマ漫画としての構成（起承転結）\n2. 2x2グリッドレイアウトの適切性\n3. キャラクターの表現と一貫性\n4. 感情や雰囲気\n5. 技術的な品質\n6. 改善点'}, {'type': 'image_url', 'image_url': {'url': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAADACAIAAABkjyoxAAAApklEQVR4nO3BMQEAAADCoPVPbQlPoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgZA3gAB7eZfogAAAABJRU5ErkJggg=='}}]}], 'model': 'gpt-4o', 'max_tokens': 1000}}
DEBUG:openai._base_client:Sending HTTP Request: POST https://api.openai.com/v1/chat/completions
DEBUG:httpcore.connection:connect_tcp.started host='api.openai.com' port=443 local_address=None timeout=5.0 socket_options=None
DEBUG:httpcore.connection:connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7f1cb28488d0>
DEBUG:httpcore.connection:start_tls.started ssl_context=<ssl.SSLContext object at 0x7f1cb363d490> server_hostname='api.openai.com' timeout=5.0
DEBUG:httpcore.connection:start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7f1cb2848950>
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:41:47 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'access-control-expose-headers', b'X-Request-ID'), (b'openai-organization', b'user-yp71vr5e7ytqmp5r0elaafpl'), (b'openai-processing-ms', b'19017'), (b'openai-version', b'2020-10-01'), (b'x-envoy-upstream-service-time', b'18992'), (b'x-ratelimit-limit-input-images', b'50000'), (b'x-ratelimit-limit-requests', b'500'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-input-images', b'49999'), (b'x-ratelimit-remaining-requests', b'499'), (b'x-ratelimit-remaining-tokens', b'29157'), (b'x-ratelimit-reset-input-images', b'1ms'), (b'x-ratelimit-reset-requests', b'120ms'), (b'x-ratelimit-reset-tokens', b'1.686s'), (b'x-request-id', b'req_9d709c80aa0d93c7d99efd681c999371'), (b'strict-transport-security', b'max-age=31536000; includeSubDomains; preload'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=e5iwc_eWsqF5OJN_5c8rZKMA1WcvKmtlI6RPGUo6IUM-1749523307-1.0.1.1-gI7NRwSHLyI73QwHX74XkPH7mCMyN.MK1qN25a6jfJmkSYRKXuooAZFm3ctE7s2Stj5A8.oiLN7dERBRQJOPf7xIx6axw_W2dX1qBedljK8; path=/; expires=Tue, 10-Jun-25 03:11:47 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), (b'X-Content-Type-Options', b'nosniff'), (b'Set-Cookie', b'_cfuvid=KT.wl7cnj8i4Sw5UxYOb0WMWxVzsraNetOYtsRmwF70-1749523307556-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'94d582868e6ce139-KIX'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:openai._base_client:HTTP Response: POST https://api.openai.com/v1/chat/completions "200 OK" Headers([('date', 'Tue, 10 Jun 2025 02:41:47 GMT'), ('content-type', 'application/json'), ('transfer-encoding', 'chunked'), ('connection', 'keep-alive'), ('access-control-expose-headers', 'X-Request-ID'), ('openai-organization', 'user-yp71vr5e7ytqmp5r0elaafpl'), ('openai-processing-ms', '19017'), ('openai-version', '2020-10-01'), ('x-envoy-upstream-service-time', '18992'), ('x-ratelimit-limit-input-images', '50000'), ('x-ratelimit-limit-requests', '500'), ('x-ratelimit-limit-tokens', '30000'), ('x-ratelimit-remaining-input-images', '49999'), ('x-ratelimit-remaining-requests', '499'), ('x-ratelimit-remaining-tokens', '29157'), ('x-ratelimit-reset-input-images', '1ms'), ('x-ratelimit-reset-requests', '120ms'), ('x-ratelimit-reset-tokens', '1.686s'), ('x-request-id', 'req_9d709c80aa0d93c7d99efd681c999371'), ('strict-transport-security', 'max-age=31536000; includeSubDomains; preload'), ('cf-cache-status', 'DYNAMIC'), ('set-cookie', '__cf_bm=e5iwc_eWsqF5OJN_5c8rZKMA1WcvKmtlI6RPGUo6IUM-1749523307-1.0.1.1-gI7NRwSHLyI73QwHX74XkPH7mCMyN.MK1qN25a6jfJmkSYRKXuooAZFm3ctE7s2Stj5A8.oiLN7dERBRQJOPf7xIx6axw_W2dX1qBedljK8; path=/; expires=Tue, 10-Jun-25 03:11:47 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('x-content-type-options', 'nosniff'), ('set-cookie', '_cfuvid=KT.wl7cnj8i4Sw5UxYOb0WMWxVzsraNetOYtsRmwF70-1749523307556-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('server', 'cloudflare'), ('cf-ray', '94d582868e6ce139-KIX'), ('content-encoding', 'gzip'), ('alt-svc', 'h3=":443"; ma=86400')])
DEBUG:openai._base_client:request_id: req_9d709c80aa0d93c7d99efd681c999371
DEBUG:openai._base_client:Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-12626cd6-87fa-4049-b5f5-2ef5687a1c8c', 'json_data': {'messages': [{'role': 'system', 'content': 'あなたはStable Diffusionのプロンプトエンジニアリングの専門家です。与えられた画像分析と元のプロンプトを基に、より効果的なプロンプトを生成してください。画像の特徴や目的に合わせて、柔軟にプロンプトを改善してください。'}, {'role': 'user', 'content': '\n以下の画像分析結果と元のプロンプトを基に、より効果的なStable Diffusionのイラスト用プロンプトを生成してください。\n\n【画像分析結果】\n申し訳ありませんが、この画像からキャラクターを特定したり、その詳細を認識することはできません。ただし、一般的な4コマ漫画についての分析はできますので、以下に説明します。\n\n1. **4コマ漫画としての構成（起承転結）**:\n    - **起**: 物語の導入部です。キャラクターや状況が紹介され、読者がストーリーに入るきっかけを作ります。\n    - **承**: 状況やキャラクターの行動が発展します。物語の流れを助長し、次への期待感を高めます。\n    - **転**: 物語の転換点で、予想外の展開やユーモラスな要素が加わります。読者の興味を引きつけます。\n    - **結**: 結論やオチが描かれ、物語が締めくくられます。\n\n2. **2x2グリッドレイアウトの適切性**:\n    - 4コマ漫画の場合、2x2グリッドは非常に一般的で、各コマが順番に読まれる構成です。このレイアウトにより、視線の流れが自然でスムーズになります。\n\n3. **キャラクターの表現と一貫性**:\n    - キャラクターの表情やボディランゲージが一貫しているか、各コマでの行動や感情が明確であることが重要です。一貫性が保たれていれば、読者はより自然に物語に入ることができます。\n\n4. **感情や雰囲気**:\n    - キャラクターの表情、背景、セリフなどを通じて、感情や雰囲気を伝えます。ストーリーやオチに合わせ、コミカルやシリアスなどのトーンをしっかり表現します。\n\n5. **技術的な品質**:\n    - 線のクオリティや色使いの明瞭さ、コマの配置とサイズが適切であるかなど、視覚的な要素が漫画の閲覧体験において影響します。\n\n6. **改善点**:\n    - キャラクターの表情をより豊かにしたり、背景を詳細にすることで物語をより引き立たせることが可能です。また、セリフや文字の配置を工夫し、読みやすさを向上させることも改善につながります。\n\nこれらの点を考慮することで、4コマ漫画の質を高めることができます。\n\n【元のプロンプト】\n【第1話：膝と膝】\n\n**シーン1:**\n- 舞台は森の中。リーダーシップのある頼れる動物のような存在が、他の4人の存在を呼び集めている。\n- 頼れる存在：「今日は特別な日だ。各自、膝と膝を突き合わせ、心を通わせよう。」\n- 他の4人は興味津々そうな表情を浮かべる。\n\n**シーン2:**\n- 優しい宝石のような存在と、明るくユーモラスな存在が膝と膝を突き合わせる。\n- 宝石のような存在：「あなたの心、とても温かいですね。」\n- ユーモラスな存在：「そりゃあ、笑いのセンスがいいからさ！」\n- 2人の距離がグッと縮まる。\n\n**シーン3:**\n- 芸術を愛する存在と、知識が豊富で思慮深い存在も膝と膝を突き合わせる。\n- 芸術を愛する存在：「あなたの作品、本当に美しい。感動したわ。」\n- 思慮深い存在：「ありがとうございます。でも、あなたの見方もまた新しい視点を開かせてくれますね。」\n- 2人の間には、深い理解が芽生える。\n\n**シーン4:**\n- 最後に頼れる存在が、全員に微笑む。\n- 頼れる存在：「膝と膝を突き合わせれば、心が通じ合うことができる。これからもお互いを理解し合い、協力していこう。」\n- 全員が頷き合い、団結を深める。\n\n【第1話完】\n\n以下の要素を考慮して、改善されたプロンプトを生成してください。\n各要素はBREAKで区切り、重み付けを指定してください：\n\n1. メインサブジェクトとキャラクター (weight: 1.2)\n2. シーンと背景 (weight: 1.0)\n3. スタイルと雰囲気 (weight: 0.8)\n4. 技術的な詳細 (weight: 0.6)\n\n出力形式：\n(subject:1.2) ... BREAK\n(background:1.0) ... BREAK\n(style:0.8) ... BREAK\n(technical:0.6) ...\n\n注意事項：\n- 各セクションは75トークン以内に収めてください\n- 重要な要素には重み付けを調整してください\n- 出力は英語で、簡潔に記述してください\n'}], 'model': 'gpt-4', 'max_tokens': 1000, 'temperature': 0.7}}
DEBUG:openai._base_client:Sending HTTP Request: POST https://api.openai.com/v1/chat/completions
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:41:57 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'access-control-expose-headers', b'X-Request-ID'), (b'openai-organization', b'user-yp71vr5e7ytqmp5r0elaafpl'), (b'openai-processing-ms', b'6250'), (b'openai-version', b'2020-10-01'), (b'x-envoy-upstream-service-time', b'6253'), (b'x-ratelimit-limit-requests', b'10000'), (b'x-ratelimit-limit-tokens', b'10000'), (b'x-ratelimit-remaining-requests', b'9999'), (b'x-ratelimit-remaining-tokens', b'8775'), (b'x-ratelimit-reset-requests', b'8.64s'), (b'x-ratelimit-reset-tokens', b'7.35s'), (b'x-request-id', b'req_501b8fd6317c72dad16f5288637eb66a'), (b'strict-transport-security', b'max-age=31536000; includeSubDomains; preload'), (b'cf-cache-status', b'DYNAMIC'), (b'X-Content-Type-Options', b'nosniff'), (b'Server', b'cloudflare'), (b'CF-RAY', b'94d58314e815e139-KIX'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:openai._base_client:HTTP Response: POST https://api.openai.com/v1/chat/completions "200 OK" Headers({'date': 'Tue, 10 Jun 2025 02:41:57 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'access-control-expose-headers': 'X-Request-ID', 'openai-organization': 'user-yp71vr5e7ytqmp5r0elaafpl', 'openai-processing-ms': '6250', 'openai-version': '2020-10-01', 'x-envoy-upstream-service-time': '6253', 'x-ratelimit-limit-requests': '10000', 'x-ratelimit-limit-tokens': '10000', 'x-ratelimit-remaining-requests': '9999', 'x-ratelimit-remaining-tokens': '8775', 'x-ratelimit-reset-requests': '8.64s', 'x-ratelimit-reset-tokens': '7.35s', 'x-request-id': 'req_501b8fd6317c72dad16f5288637eb66a', 'strict-transport-security': 'max-age=31536000; includeSubDomains; preload', 'cf-cache-status': 'DYNAMIC', 'x-content-type-options': 'nosniff', 'server': 'cloudflare', 'cf-ray': '94d58314e815e139-KIX', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
DEBUG:openai._base_client:request_id: req_501b8fd6317c72dad16f5288637eb66a
プロンプトテンプレートを追記しました: /app/src/prompts/manga_prompt.txt
画像分析とプロンプト改善完了

5. Notion連携テスト開始...
DEBUG:httpcore.connection:connect_tcp.started host='api.notion.com' port=443 local_address=None timeout=60.0 socket_options=None
DEBUG:httpcore.connection:connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7f1cb2851a90>
DEBUG:httpcore.connection:start_tls.started ssl_context=<ssl.SSLContext object at 0x7f1cb363d5b0> server_hostname='api.notion.com' timeout=60.0
DEBUG:httpcore.connection:start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7f1cb2851b50>
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:41:59 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d583424d74fcb6-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'ETag', b'W/"448-wSX0ml6v+ZCR2C1hPbc57IV3meI"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'955f5fbf-c823-46e0-8826-e78e51430d29'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Set-Cookie', b'__cf_bm=AIyZ96zW1K816A4FTLmnCroJbaVRXQIXzUGTnuGGH5E-1749523319-1.0.1.1-4QcBlhT9REzM_BRG2nZX9LuS1rlzwbg613HjHNVdwnKGXZUowgZ6nVLGBcqw9UC5jwp6_JX4oH6dTZOFft0YTy4X0.BHejpaxkkOFAGPJU8; path=/; expires=Tue, 10-Jun-25 03:11:59 GMT; domain=.notion.com; HttpOnly; Secure; SameSite=None'), (b'Set-Cookie', b'_cfuvid=CKowthGhCmOg.D6s60rgK_WEIp5j4ZNiwqwFPIIpWr4-1749523319335-0.0.1.1-604800000; path=/; domain=.notion.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: POST https://api.notion.com/v1/pages "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'POST']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:42:00 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d5834bca3afcb6-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'ETag', b'W/"214e-Lv1YeuiZ5fjQG9AhnAvO4IFWNRY"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'fe3a765c-5568-4b81-8ef9-bfd4b6bcc9da'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Server', b'cloudflare'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: PATCH https://api.notion.com/v1/blocks/20e2d8fa-cbd4-81bc-82d2-e3486ab6deb0/children "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:42:07 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d583531a0afcb6-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'ETag', b'W/"a70-xqWO/Fj1bGnIsfkZIZW3QQaiS3Y"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'be6321ef-f806-43c9-895a-2d9c16bb7fb8'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Server', b'cloudflare'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: PATCH https://api.notion.com/v1/blocks/20e2d8fa-cbd4-81bc-82d2-e3486ab6deb0/children "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
DEBUG:boto3.s3.transfer:Opting out of CRT Transfer Manager. Preferred client: auto, CRT available: False, Instance Optimized: False.
DEBUG:boto3.s3.transfer:Using default client. pid: 152, thread: 139765110963072
DEBUG:s3transfer.utils:Acquiring 0
DEBUG:s3transfer.tasks:UploadSubmissionTask(transfer_id=0, {'transfer_future': <s3transfer.futures.TransferFuture object at 0x7f1cb3e2e950>}) about to wait for the following futures []
DEBUG:s3transfer.tasks:UploadSubmissionTask(transfer_id=0, {'transfer_future': <s3transfer.futures.TransferFuture object at 0x7f1cb3e2e950>}) done waiting for dependent futures
DEBUG:s3transfer.tasks:Executing task UploadSubmissionTask(transfer_id=0, {'transfer_future': <s3transfer.futures.TransferFuture object at 0x7f1cb3e2e950>}) with kwargs {'client': <botocore.client.S3 object at 0x7f1cb4b66c10>, 'config': <boto3.s3.transfer.TransferConfig object at 0x7f1cb2843d50>, 'osutil': <s3transfer.utils.OSUtils object at 0x7f1cb3e2e050>, 'request_executor': <s3transfer.futures.BoundedExecutor object at 0x7f1cb2851110>, 'transfer_future': <s3transfer.futures.TransferFuture object at 0x7f1cb3e2e950>}
DEBUG:s3transfer.futures:Submitting task PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_024207_test_illustration.png', 'extra_args': {}}) to executor <s3transfer.futures.BoundedExecutor object at 0x7f1cb2851110> for transfer request: 0.
DEBUG:s3transfer.utils:Acquiring 0
DEBUG:s3transfer.tasks:PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_024207_test_illustration.png', 'extra_args': {}}) about to wait for the following futures []
DEBUG:s3transfer.utils:Releasing acquire 0/None
DEBUG:s3transfer.tasks:PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_024207_test_illustration.png', 'extra_args': {}}) done waiting for dependent futures
DEBUG:s3transfer.tasks:Executing task PutObjectTask(transfer_id=0, {'bucket': 'phpfuckertest', 'key': 'generated/20250610_024207_test_illustration.png', 'extra_args': {}}) with kwargs {'client': <botocore.client.S3 object at 0x7f1cb4b66c10>, 'fileobj': <s3transfer.utils.ReadFileChunk object at 0x7f1cb3e2ed50>, 'bucket': 'phpfuckertest', 'key': 'generated/20250610_024207_test_illustration.png', 'extra_args': {}}
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function validate_ascii_metadata at 0x7f1cbfeff7e0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function sse_md5 at 0x7f1cbfefeac0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function convert_body_to_file_like_object at 0x7f1cbff20220>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function validate_bucket_name at 0x7f1cbfefea20>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function remove_bucket_from_url_paths_from_model at 0x7f1cbff20c20>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <bound method S3RegionRedirectorv2.annotate_request_context of <botocore.utils.S3RegionRedirectorv2 object at 0x7f1cb47a4510>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <bound method ClientCreator._inject_s3_input_parameters of <botocore.client.ClientCreator object at 0x7f1cb4c88cd0>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.PutObject: calling handler <function generate_idempotent_uuid at 0x7f1cbfefe840>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <function customize_endpoint_resolver_builtins at 0x7f1cbff20e00>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <bound method S3RegionRedirectorv2.redirect_from_cache of <botocore.utils.S3RegionRedirectorv2 object at 0x7f1cb47a4510>>
DEBUG:botocore.regions:Calling endpoint provider with parameters: {'Bucket': 'phpfuckertest', 'Region': 'ap-northeast-1', 'UseFIPS': False, 'UseDualStack': False, 'ForcePathStyle': False, 'Accelerate': False, 'UseGlobalEndpoint': False, 'Key': 'generated/20250610_024207_test_illustration.png', 'DisableMultiRegionAccessPoints': False, 'UseArnRegion': True}
DEBUG:botocore.regions:Endpoint provider result: https://phpfuckertest.s3.ap-northeast-1.amazonaws.com
DEBUG:botocore.regions:Selecting from endpoint provider's list of auth schemes: "sigv4". User selected auth scheme is: "s3v4"
DEBUG:botocore.regions:Selected auth type "v4" as "s3v4" with signing context params: {'region': 'ap-northeast-1', 'signing_name': 's3', 'disableDoubleEncoding': True}
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function conditionally_calculate_checksum at 0x7f1cbff9df80>
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function add_expect_header at 0x7f1cbfefede0>
DEBUG:botocore.handlers:Adding expect 100 continue header to request.
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <bound method S3ExpressIdentityResolver.apply_signing_cache_key of <botocore.utils.S3ExpressIdentityResolver object at 0x7f1cb47a5050>>
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function add_recursion_detection_header at 0x7f1cbfefd120>
DEBUG:botocore.hooks:Event before-call.s3.PutObject: calling handler <function inject_api_version_header_if_needed at 0x7f1cbff20360>
DEBUG:botocore.endpoint:Making request for OperationModel(name=PutObject) with params: {'url_path': '/generated/20250610_024207_test_illustration.png', 'query_string': {}, 'method': 'PUT', 'headers': {'User-Agent': 'Boto3/1.34.69 md/Botocore#1.34.162 ua/2.0 os/linux#5.10.104-linuxkit md/arch#x86_64 lang/python#3.11.13 md/pyimpl#CPython cfg/retry-mode#standard Botocore/1.34.162', 'Content-MD5': 'fpIRfsN3+S7frPYLsDXGAQ==', 'Expect': '100-continue'}, 'body': <s3transfer.utils.ReadFileChunk object at 0x7f1cb3e2ed50>, 'auth_path': '/phpfuckertest/generated/20250610_024207_test_illustration.png', 'url': 'https://phpfuckertest.s3.ap-northeast-1.amazonaws.com/generated/20250610_024207_test_illustration.png', 'context': {'client_region': 'ap-northeast-1', 'client_config': <botocore.config.Config object at 0x7f1cb478bd90>, 'has_streaming_input': True, 'auth_type': 's3v4', 's3_redirect': {'redirected': False, 'bucket': 'phpfuckertest', 'params': {'Bucket': 'phpfuckertest', 'Key': 'generated/20250610_024207_test_illustration.png', 'Body': <s3transfer.utils.ReadFileChunk object at 0x7f1cb3e2ed50>}}, 'input_params': {'Bucket': 'phpfuckertest', 'Key': 'generated/20250610_024207_test_illustration.png'}, 'signing': {'region': 'ap-northeast-1', 'signing_name': 's3', 'disableDoubleEncoding': True}, 'endpoint_properties': {'authSchemes': [{'disableDoubleEncoding': True, 'name': 'sigv4', 'signingName': 's3', 'signingRegion': 'ap-northeast-1'}]}}}
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <function signal_not_transferring at 0x7f1cb4c04900>
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <bound method RequestSigner.handler of <botocore.signers.RequestSigner object at 0x7f1cb478bd50>>
DEBUG:botocore.hooks:Event choose-signer.s3.PutObject: calling handler <function set_operation_specific_signer at 0x7f1cbfefe700>
DEBUG:botocore.hooks:Event before-sign.s3.PutObject: calling handler <function remove_arn_from_signing_path at 0x7f1cbff20d60>
DEBUG:botocore.hooks:Event before-sign.s3.PutObject: calling handler <bound method S3ExpressIdentityResolver.resolve_s3express_identity of <botocore.utils.S3ExpressIdentityResolver object at 0x7f1cb47a5050>>
DEBUG:botocore.auth:Calculating signature using v4 auth.
DEBUG:botocore.auth:CanonicalRequest:
PUT
/generated/20250610_024207_test_illustration.png

content-md5:fpIRfsN3+S7frPYLsDXGAQ==
host:phpfuckertest.s3.ap-northeast-1.amazonaws.com
x-amz-content-sha256:UNSIGNED-PAYLOAD
x-amz-date:20250610T024208Z

content-md5;host;x-amz-content-sha256;x-amz-date
UNSIGNED-PAYLOAD
DEBUG:botocore.auth:StringToSign:
AWS4-HMAC-SHA256
20250610T024208Z
20250610/ap-northeast-1/s3/aws4_request
47504117800a7cb0998ed5c25c5a0d2b765b4684042693811dd08b02346f3e8f
DEBUG:botocore.auth:Signature:
135e18d89126887f013d790b6c8bbdc00491227f739f25c883603a56a93ec51c
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <function signal_transferring at 0x7f1cb4c049a0>
DEBUG:botocore.hooks:Event request-created.s3.PutObject: calling handler <function add_retry_headers at 0x7f1cbff20b80>
DEBUG:botocore.endpoint:Sending http request: <AWSPreparedRequest stream_output=False, method=PUT, url=https://phpfuckertest.s3.ap-northeast-1.amazonaws.com/generated/20250610_024207_test_illustration.png, headers={'User-Agent': b'Boto3/1.34.69 md/Botocore#1.34.162 ua/2.0 os/linux#5.10.104-linuxkit md/arch#x86_64 lang/python#3.11.13 md/pyimpl#CPython cfg/retry-mode#standard Botocore/1.34.162', 'Content-MD5': b'fpIRfsN3+S7frPYLsDXGAQ==', 'Expect': b'100-continue', 'X-Amz-Date': b'20250610T024208Z', 'X-Amz-Content-SHA256': b'UNSIGNED-PAYLOAD', 'Authorization': b'AWS4-HMAC-SHA256 Credential=AKIAS4J7W4GLMR5IV6UL/20250610/ap-northeast-1/s3/aws4_request, SignedHeaders=content-md5;host;x-amz-content-sha256;x-amz-date, Signature=135e18d89126887f013d790b6c8bbdc00491227f739f25c883603a56a93ec51c', 'amz-sdk-invocation-id': b'5f99927e-04c6-4905-8e2b-8072c323ce5c', 'amz-sdk-request': b'attempt=1', 'Content-Length': '223'}>
DEBUG:botocore.httpsession:Certificate path: /usr/local/lib/python3.11/site-packages/certifi/cacert.pem
DEBUG:urllib3.connectionpool:Starting new HTTPS connection (1): phpfuckertest.s3.ap-northeast-1.amazonaws.com:443
DEBUG:botocore.awsrequest:Waiting for 100 Continue response.
DEBUG:botocore.awsrequest:100 Continue response seen, now sending request body.
DEBUG:urllib3.connectionpool:https://phpfuckertest.s3.ap-northeast-1.amazonaws.com:443 "PUT /generated/20250610_024207_test_illustration.png HTTP/1.1" 200 0
DEBUG:botocore.parsers:Response headers: {'x-amz-id-2': 'ukvPkiZdXzB+brih5bj6kWzVDBr9ZaLJrLJqPGLwQwb6iiNDGgBqH2EoFt90M1KnP+cmHVnpZNQ=', 'x-amz-request-id': '8N9GVQPV6WFNGD3P', 'Date': 'Tue, 10 Jun 2025 02:42:10 GMT', 'x-amz-version-id': 'UQceStMAkgPEoP7BchBzRG9a39QATGEG', 'x-amz-server-side-encryption': 'AES256', 'ETag': '"7e92117ec377f92edfacf60bb035c601"', 'x-amz-checksum-crc64nvme': '5C8l2Q73V20=', 'x-amz-checksum-type': 'FULL_OBJECT', 'Content-Length': '0', 'Server': 'AmazonS3'}
DEBUG:botocore.parsers:Response body:
b''
DEBUG:botocore.hooks:Event needs-retry.s3.PutObject: calling handler <bound method RetryHandler.needs_retry of <botocore.retries.standard.RetryHandler object at 0x7f1cb47a4b50>>
DEBUG:botocore.retries.standard:Not retrying request.
DEBUG:botocore.hooks:Event needs-retry.s3.PutObject: calling handler <bound method S3RegionRedirectorv2.redirect_from_error of <botocore.utils.S3RegionRedirectorv2 object at 0x7f1cb47a4510>>
DEBUG:botocore.hooks:Event after-call.s3.PutObject: calling handler <bound method RetryQuotaChecker.release_retry_quota of <botocore.retries.standard.RetryQuotaChecker object at 0x7f1cb47a45d0>>
DEBUG:s3transfer.utils:Releasing acquire 0/None
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function sse_md5 at 0x7f1cbfefeac0>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function validate_bucket_name at 0x7f1cbfefea20>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function remove_bucket_from_url_paths_from_model at 0x7f1cbff20c20>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <bound method S3RegionRedirectorv2.annotate_request_context of <botocore.utils.S3RegionRedirectorv2 object at 0x7f1cb47a4510>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <bound method ClientCreator._inject_s3_input_parameters of <botocore.client.ClientCreator object at 0x7f1cb4c88cd0>>
DEBUG:botocore.hooks:Event before-parameter-build.s3.GetObject: calling handler <function generate_idempotent_uuid at 0x7f1cbfefe840>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <function customize_endpoint_resolver_builtins at 0x7f1cbff20e00>
DEBUG:botocore.hooks:Event before-endpoint-resolution.s3: calling handler <bound method S3RegionRedirectorv2.redirect_from_cache of <botocore.utils.S3RegionRedirectorv2 object at 0x7f1cb47a4510>>
DEBUG:botocore.regions:Calling endpoint provider with parameters: {'Bucket': 'phpfuckertest', 'Region': 'aws-global', 'UseFIPS': False, 'UseDualStack': False, 'ForcePathStyle': False, 'Accelerate': False, 'UseGlobalEndpoint': True, 'Key': 'generated/20250610_024207_test_illustration.png', 'DisableMultiRegionAccessPoints': False, 'UseArnRegion': True}
DEBUG:botocore.regions:Endpoint provider result: https://phpfuckertest.s3.amazonaws.com
DEBUG:botocore.regions:Selecting from endpoint provider's list of auth schemes: "sigv4". User selected auth scheme is: "s3v4"
DEBUG:botocore.regions:Selected auth type "v4" as "s3v4" with signing context params: {'region': 'us-east-1', 'signing_name': 's3', 'disableDoubleEncoding': True}
DEBUG:botocore.hooks:Event choose-signer.s3.GetObject: calling handler <function set_operation_specific_signer at 0x7f1cbfefe700>
DEBUG:botocore.hooks:Event before-sign.s3.GetObject: calling handler <function remove_arn_from_signing_path at 0x7f1cbff20d60>
DEBUG:botocore.hooks:Event before-sign.s3.GetObject: calling handler <bound method S3ExpressIdentityResolver.resolve_s3express_identity of <botocore.utils.S3ExpressIdentityResolver object at 0x7f1cb47a5050>>
DEBUG:botocore.auth:Calculating signature using v4 auth.
DEBUG:botocore.auth:CanonicalRequest:
GET
/generated/20250610_024207_test_illustration.png
X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS4J7W4GLMR5IV6UL%2F20250610%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20250610T024210Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host
host:phpfuckertest.s3.amazonaws.com

host
UNSIGNED-PAYLOAD
DEBUG:botocore.auth:StringToSign:
AWS4-HMAC-SHA256
20250610T024210Z
20250610/ap-northeast-1/s3/aws4_request
4e75063b3d1cc41cc9a45d46f8b977928d567fd6ace5fb9cae011bb47cdf9b44
DEBUG:botocore.auth:Signature:
c59bb0b270905d59b08d277c6752835dc80f0c0957dc44ef50316386ce3f5a68
[DEBUG] upload_image_to_notion: image_url: https://phpfuckertest.s3.amazonaws.com/generated/20250610_024207_test_illustration.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS4J7W4GLMR5IV6UL%2F20250610%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20250610T024210Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=c59bb0b270905d59b08d277c6752835dc80f0c0957dc44ef50316386ce3f5a68
DEBUG:httpcore.http11:send_request_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_headers.complete
DEBUG:httpcore.http11:send_request_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:send_request_body.complete
DEBUG:httpcore.http11:receive_response_headers.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 10 Jun 2025 02:42:10 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'94d5838db92ffcb6-KIX'), (b'CF-Cache-Status', b'DYNAMIC'), (b'ETag', b'W/"3f8-oPpaTgw0M/Eu9OaYe4n6aX55Khg"'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'Vary', b'Accept-Encoding'), (b'content-security-policy', b"default-src 'none'"), (b'referrer-policy', b'strict-origin-when-cross-origin'), (b'x-content-type-options', b'nosniff'), (b'x-dns-prefetch-control', b'off'), (b'x-download-options', b'noopen'), (b'x-frame-options', b'SAMEORIGIN'), (b'x-notion-request-id', b'c3f1f87d-c755-4308-9c02-bcea1057e661'), (b'x-permitted-cross-domain-policies', b'none'), (b'x-xss-protection', b'0'), (b'Server', b'cloudflare'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
INFO:httpx:HTTP Request: PATCH https://api.notion.com/v1/blocks/20e2d8fa-cbd4-81bc-82d2-e3486ab6deb0/children "HTTP/1.1 200 OK"
DEBUG:httpcore.http11:receive_response_body.started request=<Request [b'PATCH']>
DEBUG:httpcore.http11:receive_response_body.complete
DEBUG:httpcore.http11:response_closed.started
DEBUG:httpcore.http11:response_closed.complete
[DEBUG] upload_image_to_notion: append response: {'object': 'list', 'results': [{'object': 'block', 'id': '20e2d8fa-cbd4-81df-aee2-e1dfef8632a8', 'parent': {'type': 'page_id', 'page_id': '20e2d8fa-cbd4-81bc-82d2-e3486ab6deb0'}, 'created_time': '2025-06-10T02:42:00.000Z', 'last_edited_time': '2025-06-10T02:42:00.000Z', 'created_by': {'object': 'user', 'id': '2e7c4192-3008-4b55-9edf-b96cf513694e'}, 'last_edited_by': {'object': 'user', 'id': '2e7c4192-3008-4b55-9edf-b96cf513694e'}, 'has_children': False, 'archived': False, 'in_trash': False, 'type': 'image', 'image': {'caption': [], 'type': 'external', 'external': {'url': 'https://phpfuckertest.s3.amazonaws.com/generated/20250610_024207_test_illustration.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS4J7W4GLMR5IV6UL%2F20250610%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20250610T024210Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=c59bb0b270905d59b08d277c6752835dc80f0c0957dc44ef50316386ce3f5a68'}}}], 'next_cursor': None, 'has_more': False, 'type': 'block', 'block': {}, 'request_id': 'c3f1f87d-c755-4308-9c02-bcea1057e661'}
Notionへの保存完了: 20e2d8fa-cbd4-81bc-82d2-e3486ab6deb0

テスト完了: すべての処理が正常に実行されました
.
----------------------------------------------------------------------
Ran 1 test in 419.626s

OK
DEBUG:httpcore.connection:close.started
DEBUG:httpcore.connection:close.complete
DEBUG:httpcore.connection:close.started
DEBUG:httpcore.connection:close.complete